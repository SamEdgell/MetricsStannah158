# Third party imports.
from PySide6.QtCore import QTimer

# Local application imports.
from Enums.enum_msg import MessageID, MsgMode, SrcDest
from messages import buildMessage, SrcDest


class UIDemo:
    """
    Class providing the demo feature for the application.
    Simulates ADC, input, and output data for demonstration purposes, allowing the user interface to display changing values without real hardware.
    """

    def __init__(self, main_window):
        """
        Initialises the UIDemo class.

        Args:
            main_window: Reference to the main window, used for accessing UI elements.
        """
        self.main_window = main_window

        self.active = False

        # ADC demo data.
        self.ecu1_ADC_payloads = [
            # Num CH     Raw0    Scaled  Raw1    Scaled  Raw2    Scaled  Raw3    Scaled  Raw4    Scaled  Raw5    Scaled  Raw6    Scaled  Raw7    Scaled  Raw8    Scaled  Raw9    Scaled  Raw10   Scaled  Raw11   Scaled  Raw12   Scaled  Raw13   Scaled  Raw14   Scaled
            (0x00000003, 0x0979, 0x654A, 0x0003, 0x0023, 0x07CF, 0x5570, 0x03FE, 0x1ECE, 0x0965, 0x656F, 0x0570, 0x392A, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000),
            (0x00000003, 0x0969, 0x64E6, 0x0004, 0x0024, 0x07DC, 0x5580, 0x0402, 0x1EBE, 0x0986, 0x6578, 0x0578, 0x393A, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000),
            (0x00000003, 0x0973, 0x652C, 0x0005, 0x0025, 0x07DF, 0x5590, 0x040F, 0x1EB0, 0x0980, 0x6570, 0x058A, 0x393F, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000),
            (0x00000003, 0x0979, 0x654A, 0x0003, 0x0023, 0x07CF, 0x5570, 0x03FE, 0x1ECE, 0x0965, 0x656F, 0x0570, 0x392A, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000),
            (0x00000003, 0x0969, 0x64E6, 0x0004, 0x0024, 0x07DC, 0x5580, 0x0402, 0x1EBE, 0x0986, 0x6578, 0x0578, 0x393A, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000),
            (0x00000003, 0x0973, 0x652C, 0x0005, 0x0025, 0x07DF, 0x5590, 0x040F, 0x1EB0, 0x0980, 0x6570, 0x058A, 0x393F, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000),
        ]
        self.ecu2_ADC_payloads = [
            (0x00000003, 0x0FAF, 0x0C80, 0x0570, 0x392A, 0x0573, 0x3935, 0x0009, 0x0022, 0x0980, 0x65F0, 0x0009, 0x0022, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000),
            (0x00000003, 0x0FAF, 0x0C80, 0x0578, 0x393A, 0x0580, 0x393E, 0x000F, 0x0027, 0x098A, 0x65FF, 0x000F, 0x0027, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000),
            (0x00000003, 0x07D4, 0x0640, 0x058A, 0x393F, 0x058B, 0x3942, 0x000D, 0x0024, 0x0987, 0x65F7, 0x000D, 0x0024, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000),
            (0x00000003, 0x0FAF, 0x0C80, 0x0570, 0x392A, 0x0573, 0x3935, 0x0009, 0x0022, 0x0980, 0x65F0, 0x0009, 0x0022, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000),
            (0x00000003, 0x0FAF, 0x0C80, 0x0578, 0x393A, 0x0580, 0x393E, 0x000F, 0x0027, 0x098A, 0x65FF, 0x000F, 0x0027, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000),
            (0x00000003, 0x07D4, 0x0640, 0x058A, 0x393F, 0x058B, 0x3942, 0x000D, 0x0024, 0x0987, 0x65F7, 0x000D, 0x0024, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000),
        ]
        self.demo_ADC_index = 0

        # Inputs demo data.
        self.ecu1_input_payloads = [
            # Num In     Word 1      Word 2      Word 3      Word 4      Ovr Word 1  Ovr Word 2  Ovr Word 3  Ovr Word 4
            (0x00000003, 0x00000001, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000),
            (0x00000003, 0x00000003, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000),
            (0x00000003, 0x00000007, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000),
            (0x00000003, 0x00000003, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000),
            (0x00000003, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000),
            (0x00000003, 0x00000002, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000),
        ]
        self.ecu2_input_payloads = [
            (0x00000003, 0x00000003, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000),
            (0x00000003, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000),
            (0x00000003, 0x00000003, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000),
            (0x00000003, 0x00000007, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000),
            (0x00000003, 0x00000007, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000),
            (0x00000003, 0x00000001, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000),
        ]
        self.demo_inputs_index = 0

        # Outputs demo data.
        self.ecu1_output_payloads = [
            # Num Out    Word 1      Word 2      Word 3      Word 4      Ovr Word 1  Ovr Word 2  Ovr Word 3  Ovr Word 4
            (0x00000003, 0x00000003, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000),
            (0x00000003, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000),
            (0x00000003, 0x00000003, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000),
            (0x00000003, 0x00000007, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000),
            (0x00000003, 0x00000007, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000),
            (0x00000003, 0x00000001, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000),
        ]
        self.ecu2_output_payloads = [
            (0x00000003, 0x00000001, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000),
            (0x00000003, 0x00000003, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000),
            (0x00000003, 0x00000007, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000),
            (0x00000003, 0x00000003, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000),
            (0x00000003, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000),
            (0x00000003, 0x00000002, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000),
        ]
        self.demo_outputs_index = 0


    def start(self):
        """
        Starts demo mode.
        """
        self.main_window.ui_console.logDebugConsole("Starting demo mode.")

        # ADC
        self.adc_test_timer = QTimer()
        self.adc_test_timer.timeout.connect(self.demoADC)
        self.adc_test_timer.start(800)

        # Inputs
        self.inputs_test_timer = QTimer()
        self.inputs_test_timer.timeout.connect(self.demoInputs)
        self.inputs_test_timer.start(800)

        # Outputs
        self.outputs_test_timer = QTimer()
        self.outputs_test_timer.timeout.connect(self.demoOutputs)
        self.outputs_test_timer.start(800)

        self.active = True


    def stop(self):
        """
        Stops demo mode.
        """
        self.main_window.ui_console.logDebugConsole("Stopping demo mode.")
        self.adc_test_timer.stop()
        self.inputs_test_timer.stop()
        self.outputs_test_timer.stop()
        self.active = False


    def isActive(self):
        """
        Returns if demo mode is active.
        """
        return self.active


    def demoADC(self):
        """
        Demo's the ADC table.
        """
        msg_ECU_1_ADC = bytearray(buildMessage(MessageID.ADC_STATUS, "I30H", self.ecu1_ADC_payloads[self.demo_ADC_index], SrcDest.SRC_DEST_PC, MsgMode.OUT, SrcDest.SRC_DEST_ECU1))
        msg_ECU_2_ADC = bytearray(buildMessage(MessageID.ADC_STATUS, "I30H", self.ecu2_ADC_payloads[self.demo_ADC_index], SrcDest.SRC_DEST_PC, MsgMode.OUT, SrcDest.SRC_DEST_ECU2))

        # For this test the message does not need encoding as we are routing internally, but a CRC should be appended still.
        msg_ECU_1_ADC.append(0x00)
        msg_ECU_2_ADC.append(0x00)

        self.main_window.ui_comms.handleMessage(msg_ECU_1_ADC)
        self.main_window.ui_comms.handleMessage(msg_ECU_2_ADC)

        self.demo_ADC_index = (self.demo_ADC_index + 1) % len(self.ecu1_ADC_payloads)


    def demoInputs(self):
        """
        Demo's the Inputs table.
        """
        msg_ECU_1In = bytearray(buildMessage(MessageID.GPIO_INPUTS_STATUS, "9I", self.ecu1_input_payloads[self.demo_inputs_index], SrcDest.SRC_DEST_PC, MsgMode.OUT, SrcDest.SRC_DEST_ECU1))
        msg_ECU_2In = bytearray(buildMessage(MessageID.GPIO_INPUTS_STATUS, "9I", self.ecu2_input_payloads[self.demo_inputs_index], SrcDest.SRC_DEST_PC, MsgMode.OUT, SrcDest.SRC_DEST_ECU2))

        # For this test the message does not need encoding as we are routing internally, but a CRC should be appended still.
        msg_ECU_1In.append(0x00)
        msg_ECU_2In.append(0x00)

        self.main_window.ui_comms.handleMessage(msg_ECU_1In)
        self.main_window.ui_comms.handleMessage(msg_ECU_2In)

        self.demo_inputs_index = (self.demo_inputs_index + 1) % len(self.ecu1_input_payloads)


    def demoOutputs(self):
        """
        Demo's the Outputs table.
        """
        msg_ECU_1Out = bytearray(buildMessage(MessageID.GPIO_OUTPUTS_STATUS, "9I", self.ecu1_output_payloads[self.demo_outputs_index], SrcDest.SRC_DEST_PC, MsgMode.OUT, SrcDest.SRC_DEST_ECU1))
        msg_ECU_2Out = bytearray(buildMessage(MessageID.GPIO_OUTPUTS_STATUS, "9I", self.ecu2_output_payloads[self.demo_outputs_index], SrcDest.SRC_DEST_PC, MsgMode.OUT, SrcDest.SRC_DEST_ECU2))

        # For this test the message does not need encoding as we are routing internally, but a CRC should be appended still.
        msg_ECU_1Out.append(0x00)
        msg_ECU_2Out.append(0x00)

        self.main_window.ui_comms.handleMessage(msg_ECU_1Out)
        self.main_window.ui_comms.handleMessage(msg_ECU_2Out)

        self.demo_outputs_index = (self.demo_outputs_index + 1) % len(self.ecu1_output_payloads)